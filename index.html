<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestione Conti - Cloud GitHub</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background-color: #f8f9fa; font-family: Inter, sans-serif; }
    .section-card { @apply bg-white p-6 rounded-lg shadow-sm mb-6 border border-gray-100; }
    
    /* Stile Pulsanti */
    :root { --btn-radius: 9999px; --btn-height: 48px; }
    .btn-base { @apply inline-flex items-center justify-center font-semibold tracking-tight transition-all duration-200; height: var(--btn-height); border-radius: var(--btn-radius); padding-inline: 1.5rem; }
    .btn-primary { @apply btn-base bg-indigo-600 hover:bg-indigo-700 text-white shadow-md hover:shadow-lg; }
    .btn-secondary { @apply btn-base bg-blue-600 hover:bg-blue-700 text-white shadow-md hover:shadow-lg; }
    .btn-outline { @apply btn-base bg-white text-gray-700 border border-gray-300 hover:bg-gray-50; }
    .btn-danger { @apply btn-base text-red-600 hover:bg-red-50 border border-transparent hover:border-red-200; }

    /* Tab Grafici */
    .tab-active { @apply bg-indigo-600 text-white border-indigo-600; }
    .tab-inactive { @apply bg-white text-gray-600 border-gray-300 hover:bg-gray-50; }
  </style>
</head>

<body class="p-4 md:p-8 max-w-7xl mx-auto pb-20">
  
  <!-- Header -->
  <div class="text-center mb-8">
    <h1 class="text-3xl md:text-4xl font-bold text-indigo-900 mb-2">Gestione Conti Personali</h1>
    <div id="ghStatus" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-500">
      <span class="w-2 h-2 rounded-full bg-gray-400 mr-2 animate-pulse"></span> In attesa...
    </div>
  </div>

  <!-- Inserimento Dati -->
  <div class="section-card bg-indigo-50 border-indigo-100">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-indigo-800">Nuova Registrazione</h2>
      <input type="month" id="inputMonth" class="bg-white border border-indigo-200 rounded px-3 py-2 text-indigo-900 font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500">
    </div>

    <form id="entryForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
      <!-- Input generati via JS -->
      <div id="accountInputsContainer" class="contents"></div>
    </form>

    <div class="flex justify-end pt-4 border-t border-indigo-200">
      <button type="button" onclick="saveData()" class="btn-primary w-full md:w-auto min-w-[200px]">
        Salva e Sincronizza
      </button>
    </div>
  </div>

  <!-- Grafici -->
  <div class="section-card">
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
      <h2 class="text-xl font-bold text-gray-800">Andamento Finanziario</h2>
      
      <div class="flex bg-gray-100 p-1 rounded-full overflow-x-auto max-w-full">
        <button onclick="setChartMode('single')" id="tab-single" class="px-4 py-1.5 text-sm rounded-full transition-all whitespace-nowrap">Conti</button>
        <button onclick="setChartMode('aggregated')" id="tab-aggregated" class="px-4 py-1.5 text-sm rounded-full transition-all whitespace-nowrap">Gruppi</button>
        <button onclick="setChartMode('total')" id="tab-total" class="px-4 py-1.5 text-sm rounded-full transition-all whitespace-nowrap">Totale</button>
        <button onclick="setChartMode('variation')" id="tab-variation" class="px-4 py-1.5 text-sm rounded-full transition-all whitespace-nowrap">Variazione</button>
      </div>
    </div>

    <div id="chartFilterContainer" class="mb-4 flex justify-end">
      <select id="chartFilter" onchange="updateChart()" class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2">
        <option value="all">Mostra Tutti i Conti</option>
      </select>
    </div>

    <div class="relative h-80 w-full">
      <canvas id="financeChart"></canvas>
    </div>
  </div>

  <!-- Tabella Storico -->
  <div class="section-card">
    <h2 class="text-xl font-bold text-gray-800 mb-4">Storico Mensile</h2>
    <div class="overflow-x-auto rounded-lg border border-gray-200">
      <table class="min-w-full bg-white text-sm">
        <thead class="bg-gray-50 text-gray-600 uppercase text-xs font-semibold tracking-wider">
          <tr>
            <th class="py-3 px-4 text-left border-b">Mese</th>
            <th id="headerPlaceholder"></th> <!-- Placeholder dinamico -->
            <th class="py-3 px-4 text-right border-b">Azioni</th>
          </tr>
        </thead>
        <tbody id="dataTableBody" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
    <div id="emptyState" class="text-center py-12 text-gray-400 hidden">
      Nessun dato presente nel database.
    </div>
  </div>

  <!-- JAVASCRIPT APP -->
  <script>
    // --- CONFIGURAZIONE ---
    const GH_USER = "Zizzo91";
    const GH_REPO = "gestione-conti";
    const GH_FILE = "finance-backup.json"; // Uso il file che hai già caricato
    const GH_BRANCH = "main"; 
    
    const ACCOUNTS = [
      { id: "ccasimone", label: "CC Arancio Simone", color: "#8b5cf6" },
      { id: "casimone", label: "Conto Arancio Simone", color: "#10b981" },
      { id: "ccamichela", label: "CC Arancio Michela", color: "#f59e0b" },
      { id: "camichela", label: "Conto Arancio Michela", color: "#f97316" },
      { id: "creditagricole", label: "Credit Agricole", color: "#3b82f6" }
    ];

    let appData = [];
    let chartInstance = null;
    let currentChartMode = "single";

    // --- AVVIO APP ---
    document.addEventListener("DOMContentLoaded", async () => {
      initUI();
      checkMagicLink(); // 1. Verifica token da URL
      await loadData(); // 2. Carica dati (Cloud o Locale)
      
      // Imposta mese corrente
      document.getElementById("inputMonth").value = new Date().toISOString().slice(0, 7);
    });

    // --- GESTIONE TOKEN (MAGIC LINK) ---
    function checkMagicLink() {
        const urlParams = new URLSearchParams(window.location.search);
        const magicToken = urlParams.get('token');

        if (magicToken) {
            localStorage.setItem("gh_token", magicToken);
            // Pulisci URL per sicurezza
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.replaceState({path: newUrl}, '', newUrl);
            alert("✅ Dispositivo autorizzato con successo!");
        }
    }

    function setStatus(msg, type = "neutral") {
        const el = document.getElementById("ghStatus");
        const dot = el.querySelector("span");
        el.innerHTML = ""; // Reset
        
        let colorClass = "bg-gray-400";
        if(type === "success") colorClass = "bg-green-500";
        if(type === "error") colorClass = "bg-red-500";
        if(type === "loading") colorClass = "bg-blue-500 animate-pulse";

        const dotSpan = document.createElement("span");
        dotSpan.className = `w-2 h-2 rounded-full mr-2 ${colorClass}`;
        
        el.appendChild(dotSpan);
        el.appendChild(document.createTextNode(msg));
        
        if(type === "success") el.className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-50 text-green-700";
        else if(type === "error") el.className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-50 text-red-700";
        else el.className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-500";
    }

    // --- CORE DATI ---
    async function loadData() {
        setStatus("Sincronizzazione in corso...", "loading");
        
        // 1. Prova da GitHub (Pubblico)
        try {
            const cacheBuster = "?t=" + new Date().getTime();
            const url = `https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/${GH_BRANCH}/${GH_FILE}${cacheBuster}`;
            const response = await fetch(url);
            
            if (response.ok) {
                appData = await response.json();
                localStorage.setItem("financeApp_data", JSON.stringify(appData)); // Backup locale
                setStatus("Dati sincronizzati", "success");
            } else {
                throw new Error("File remoto non trovato");
            }
        } catch (e) {
            // 2. Fallback Locale
            console.warn("GitHub offline o vuoto, uso locale:", e);
            const stored = localStorage.getItem("financeApp_data");
            if (stored) {
                appData = JSON.parse(stored);
                setStatus("Modo Offline (Dati Locali)", "neutral");
            } else {
                setStatus("Nessun dato trovato", "neutral");
            }
        }
        
        renderAll();
    }

    async function saveData() {
        if(!validateForm()) return;

        // 1. Aggiorna stato locale
        updateLocalState();
        renderAll();

        // 2. Salva su GitHub
        const token = localStorage.getItem("gh_token");
        if (!token) {
            alert("⚠️ ATTENZIONE: Questo dispositivo non è abilitato alla scrittura.\n\nUsa il 'Magic Link' generato dal tuo PC principale per abilitarlo.");
            return;
        }

        setStatus("Salvataggio su Cloud...", "loading");

        try {
            const apiUrl = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_FILE}`;
            
            // Ottieni SHA file attuale
            let sha = null;
            try {
                const getResp = await fetch(apiUrl, { 
                    headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' } 
                });
                if (getResp.ok) sha = (await getResp.json()).sha;
            } catch (e) {}

            // Invio aggiornamento
            const contentBase64 = window.btoa(unescape(encodeURIComponent(JSON.stringify(appData, null, 2))));
            
            const putResp = await fetch(apiUrl, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: "Update " + new Date().toISOString().slice(0, 10),
                    content: contentBase64,
                    sha: sha 
                })
            });

            if (!putResp.ok) throw new Error(putResp.statusText);
            
            setStatus("Salvato con successo!", "success");
            setTimeout(() => setStatus("Pronto", "neutral"), 3000);

        } catch (error) {
            console.error(error);
            setStatus("Errore Salvataggio Cloud", "error");
            alert("Errore GitHub: " + error.message);
        }
    }

    // --- LOGICHE UI ---
    function validateForm() {
        const month = document.getElementById("inputMonth").value;
        if (!month) { alert("Seleziona un mese."); return false; }
        
        let hasValue = false;
        ACCOUNTS.forEach(acc => {
            if(parseCurrency(document.getElementById("input" + acc.id).value) !== 0) hasValue = true;
        });
        
        if(!hasValue) { alert("Inserisci almeno un valore."); return false; }
        
        // Verifica sovrascrittura
        const exists = appData.find(d => d.month === month);
        if (exists && !confirm(`Esistono già dati per ${month}. Sovrascrivere?`)) return false;
        
        return true;
    }

    function updateLocalState() {
        const month = document.getElementById("inputMonth").value;
        const values = {};
        ACCOUNTS.forEach(acc => {
            values[acc.id] = parseCurrency(document.getElementById("input" + acc.id).value);
        });

        // Rimuovi se esiste già, poi aggiungi
        appData = appData.filter(d => d.month !== month);
        appData.push({ month, values });
        appData.sort((a, b) => b.month.localeCompare(a.month)); // Ordina per data
        
        localStorage.setItem("financeApp_data", JSON.stringify(appData));
    }

    function initUI() {
      // Genera Input
      const container = document.getElementById("accountInputsContainer");
      const filter = document.getElementById("chartFilter");
      container.innerHTML = "";
      
      // Pulisci select mantenendo opzione default
      while (filter.options.length > 1) filter.remove(1);

      ACCOUNTS.forEach((acc) => {
        // Input Card
        const div = document.createElement("div");
        div.className = "bg-white p-3 rounded border border-gray-200 shadow-sm";
        div.innerHTML = `
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">${acc.label}</label>
          <input type="text" id="input${acc.id}" placeholder="0,00 €" onblur="formatInput(this)" 
            class="w-full text-lg font-mono text-gray-800 focus:outline-none border-b border-transparent focus:border-indigo-500 transition-colors bg-transparent">
        `;
        container.appendChild(div);
        
        // Opzione Filtro Grafico
        const opt = document.createElement("option");
        opt.value = acc.id; opt.innerText = acc.label;
        filter.appendChild(opt);
      });

      // Genera Header Tabella
      const headerRow = document.querySelector("thead tr");
      const actionHeader = headerRow.lastElementChild;
      
      // Rimuovi vecchie colonne (mantieni solo la prima 'Mese' e l'ultima 'Azioni')
      while(headerRow.children.length > 2) headerRow.removeChild(headerRow.children[1]); 
      
      document.getElementById("headerPlaceholder")?.remove(); // Cleanup

      ACCOUNTS.forEach((acc) => {
        const th = document.createElement("th");
        th.className = "py-3 px-4 text-left font-semibold text-gray-600 border-b hidden md:table-cell"; // Nascondi su mobile per spazio
        th.innerText = acc.label.replace("Conto Corrente", "CC").replace("Conto", "C.");
        headerRow.insertBefore(th, actionHeader);
      });
    }

    function renderAll() { renderTable(); updateChart(); }

    // --- TABELLA & UTILS ---
    function renderTable() {
      const tbody = document.getElementById("dataTableBody");
      tbody.innerHTML = "";
      document.getElementById("emptyState").classList.toggle("hidden", appData.length > 0);

      appData.forEach((row) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 transition-colors group";
        
        let html = `<td class="py-4 px-4 font-medium text-indigo-900 whitespace-nowrap">${row.month}</td>`;
        
        ACCOUNTS.forEach((acc) => {
          const val = row.values[acc.id] || 0;
          html += `<td class="py-4 px-4 text-gray-600 hidden md:table-cell font-mono text-xs">${val === 0 ? "-" : formatCurrency(val)}</td>`;
        });
        
        html += `
          <td class="py-4 px-4 text-right whitespace-nowrap">
            <button onclick="editEntry('${row.month}')" class="text-indigo-600 hover:text-indigo-900 font-medium text-sm mr-3">Modifica</button>
            <button onclick="deleteEntry('${row.month}')" class="text-red-400 hover:text-red-700 font-medium text-sm">Elimina</button>
          </td>`;
        tr.innerHTML = html;
        tbody.appendChild(tr);
      });
    }

    function deleteEntry(month) {
        if (!confirm(`Eliminare ${month}?`)) return;
        appData = appData.filter(d => d.month !== month);
        saveDataToCloudOnly(); // Salva senza validazione form
    }

    async function saveDataToCloudOnly() {
        localStorage.setItem("financeApp_data", JSON.stringify(appData));
        renderAll();
        // Richiama la logica di salvataggio (bypassando il form)
        const token = localStorage.getItem("gh_token");
        if(token) await saveData(); 
    }

    function editEntry(month) {
        const entry = appData.find(d => d.month === month);
        if(!entry) return;
        document.getElementById("inputMonth").value = entry.month;
        ACCOUNTS.forEach(acc => {
            const el = document.getElementById("input" + acc.id);
            const val = entry.values[acc.id] || 0;
            el.value = val === 0 ? "" : new Intl.NumberFormat("it-IT", { minimumFractionDigits: 2 }).format(val/100);
        });
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // --- FORMATTAZIONE NUMERI ---
    function parseCurrency(str) {
      if (!str) return 0;
      let clean = str.replace(/[^0-9,\.]/g, "");
      clean = clean.includes(",") ? clean.replace(/\./g, "").replace(",", ".") : clean.replace(/\./g, "");
      const floatVal = parseFloat(clean);
      return isNaN(floatVal) ? 0 : Math.round(floatVal * 100);
    }
    function formatCurrency(cents) {
      return new Intl.NumberFormat("it-IT", { style: "currency", currency: "EUR" }).format(cents / 100);
    }
    function formatInput(el) {
      const val = parseCurrency(el.value);
      el.value = val === 0 ? "" : new Intl.NumberFormat("it-IT", { minimumFractionDigits: 2 }).format(val / 100);
    }

    // --- GRAFICI ---
    function initChart() { /* Lazy init in updateChart */ }
    
    function setChartMode(mode) {
      currentChartMode = mode;
      ["single", "aggregated", "total", "variation"].forEach(m => {
        const btn = document.getElementById("tab-" + m);
        if(btn) btn.className = m === mode ? "px-4 py-1.5 text-sm rounded-full bg-indigo-600 text-white shadow-sm" : "px-4 py-1.5 text-sm rounded-full bg-white text-gray-600 hover:bg-gray-50";
      });
      document.getElementById("chartFilterContainer").style.display = mode === "single" ? "flex" : "none";
      updateChart();
    }

    function updateChart() {
      const ctx = document.getElementById("financeChart").getContext("2d");
      if (!chartInstance) {
        chartInstance = new Chart(ctx, {
            type: "line",
            data: { labels: [], datasets: [] },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: "index", intersect: false },
                plugins: { legend: { position: 'bottom' } },
                scales: { y: { beginAtZero: true, ticks: { callback: (val) => new Intl.NumberFormat("it-IT", { notation: "compact", style: "currency", currency: "EUR" }).format(val) } } }
            }
        });
      }

      const sorted = [...appData].sort((a, b) => a.month.localeCompare(b.month));
      const labels = sorted.map(d => d.month);
      let datasets = [];

      if (currentChartMode === "single") {
        const filterId = document.getElementById("chartFilter").value;
        ACCOUNTS.forEach(acc => {
          if (filterId !== "all" && filterId !== acc.id) return;
          datasets.push({
            label: acc.label,
            data: sorted.map(d => (d.values[acc.id] || 0) / 100),
            borderColor: acc.color, backgroundColor: acc.color, tension: 0.3
          });
        });
      } else if (currentChartMode === "aggregated") {
          // Esempio Gruppi
          const groups = [
            { name: "Totale Simone", keyword: "Simone", color: "#8b5cf6" },
            { name: "Totale Michela", keyword: "Michela", color: "#f97316" }
          ];
          groups.forEach(g => {
             const data = sorted.map(d => {
                 let sum = 0;
                 ACCOUNTS.forEach(acc => { if(acc.label.includes(g.keyword)) sum += d.values[acc.id] || 0; });
                 return sum / 100;
             });
             datasets.push({ label: g.name, data, borderColor: g.color, backgroundColor: g.color, tension: 0.3 });
          });
      } else if (currentChartMode === "total") {
          const data = sorted.map(d => {
             let sum = 0; ACCOUNTS.forEach(acc => sum += d.values[acc.id] || 0); return sum/100; 
          });
          datasets.push({ label: "Patrimonio Netto", data, borderColor: "#1e3a8a", backgroundColor: "rgba(30, 58, 138, 0.1)", fill: true, tension: 0.4 });
      } else if (currentChartMode === "variation") {
          const data = sorted.map((d, i) => {
              if (i===0) return 0;
              let curr=0, prev=0;
              ACCOUNTS.forEach(acc => { curr += d.values[acc.id]||0; prev += sorted[i-1].values[acc.id]||0; });
              return (curr - prev)/100;
          });
          datasets.push({ type: 'bar', label: "Variazione Mensile", data, backgroundColor: data.map(v => v >= 0 ? "#10b981" : "#ef4444") });
      }

      chartInstance.data.labels = labels;
      chartInstance.data.datasets = datasets;
      chartInstance.update();
    }
  </script>
</body>
</html>
